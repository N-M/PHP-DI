<!DOCTYPE html>
<!--[if lt IE 7]>
<html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>
<html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>
<html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js"> <!--<![endif]-->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>PHP-DI - The Dependency Injection Container for humans</title>
    <meta name="description" content="PHP-DI is a Dependency Injection Container for PHP that intends to be practical and powerful.">

    <link rel="canonical" href="https://php-di.org" />

    <meta name="application-name" content="PHP-DI"/>
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://php-di.org/img/apple-touch-icon-144x144.png" />
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="https://php-di.org/img/apple-touch-icon-152x152.png" />
    <link rel="icon" type="image/png" href="https://php-di.org/img/favicon-32x32.png" sizes="32x32" />
    <link rel="icon" type="image/png" href="https://php-di.org/img/favicon-16x16.png" sizes="16x16" />
    <meta name="msapplication-TileColor" content="#484949" />
    <meta name="msapplication-TileImage" content="https://php-di.org/img/mstile-144x144.png" />

            <link href="https://fonts.googleapis.com/css?family=Abel:400|Oswald:300,400,700" media="all" rel="stylesheet" type="text/css">
        <link href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css" rel="stylesheet">
        <link href="https://php-di.org/css/highlight.github.css" rel="stylesheet">
        <link href="https://php-di.org/css/all.min.css" rel="stylesheet">
    
    <script async defer data-domain="php-di.org" src="https://plausible.io/js/plausible.js"></script>
</head>
<body>

    <header>
        <div class="navbar navbar-default navbar-fixed-top">
            <div class="container">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#top-navigation">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="https://php-di.org/" title="Dependency injection container for PHP">PHP-DI</a>
                </div>
                <div class="navbar-form navbar-left hidden-xs hidden-sm">
                    <input id="search-input" type="text" class="form-control" placeholder="Search...">
                </div>
                <div class="collapse navbar-collapse" id="top-navigation">
                    <ul class="nav navbar-nav navbar-right">
                        <li><a href="https://php-di.org/doc/getting-started.html" title="Getting started with PHP-DI">Getting started</a></li>
                        <li><a href="https://php-di.org/doc/" title="PHP-DI documentation">Documentation</a></li>
                        <li><a href="https://php-di.org/support.html" title="Enterprise support for PHP-DI">For Enterprise</a></li>
                        <li><a href="https://php-di.org/news/" title="News about PHP-DI">News</a></li>
                        <li><a href="https://php-di.org/change-log.html" title="PHP-DI's changelog">Changelog</a></li>
                        <li><a class="github" href="https://github.com/PHP-DI/PHP-DI" title="PHP-DI on GitHub"><i class="fa fa-github"></i></a></li>
                    </ul>
                </div>
            </div>
        </div>
    </header>

    
    <div class="container documentation">

        <div class="sidebar">
            <ul>
                                    <li>
                        <span class="section-title">Introduction</span>

                        <ul>
                                                            <li class="">
                                    <a href="https://php-di.org/doc/getting-started.html">
                                        Getting started
                                    </a>
                                </li>
                                                            <li class="">
                                    <a href="https://php-di.org/doc/understanding-di.html">
                                        Understanding dependency injection
                                    </a>
                                </li>
                                                            <li class="">
                                    <a href="https://php-di.org/doc/best-practices.html">
                                        "Best practices" guide
                                    </a>
                                </li>
                                                    </ul>
                    </li>
                                    <li>
                        <span class="section-title">Usage</span>

                        <ul>
                                                            <li class="">
                                    <a href="https://php-di.org/doc/container-configuration.html">
                                        Configuring the container
                                    </a>
                                </li>
                                                            <li class="">
                                    <a href="https://php-di.org/doc/container.html">
                                        Using the container
                                    </a>
                                </li>
                                                    </ul>
                    </li>
                                    <li>
                        <span class="section-title">Definitions</span>

                        <ul>
                                                            <li class="">
                                    <a href="https://php-di.org/doc/definition.html">
                                        Introduction
                                    </a>
                                </li>
                                                            <li class="">
                                    <a href="https://php-di.org/doc/autowiring.html">
                                        Autowiring
                                    </a>
                                </li>
                                                            <li class="">
                                    <a href="https://php-di.org/doc/php-definitions.html">
                                        PHP definitions
                                    </a>
                                </li>
                                                            <li class="">
                                    <a href="https://php-di.org/doc/attributes.html">
                                        PHP attributes
                                    </a>
                                </li>
                                                            <li class="">
                                    <a href="https://php-di.org/doc/annotations.html">
                                        Annotations
                                    </a>
                                </li>
                                                            <li class="">
                                    <a href="https://php-di.org/doc/definition-overriding.html">
                                        Definition extensions and overriding
                                    </a>
                                </li>
                                                    </ul>
                    </li>
                                    <li>
                        <span class="section-title">Frameworks</span>

                        <ul>
                                                            <li class="">
                                    <a href="https://php-di.org/doc/frameworks/slim.html">
                                        Slim
                                    </a>
                                </li>
                                                            <li class="">
                                    <a href="https://php-di.org/doc/frameworks/symfony2.html">
                                        Symfony
                                    </a>
                                </li>
                                                            <li class="">
                                    <a href="https://php-di.org/doc/frameworks/zf2.html">
                                        Zend Framework 2
                                    </a>
                                </li>
                                                            <li class="">
                                    <a href="https://php-di.org/doc/frameworks/zf1.html">
                                        Zend Framework 1
                                    </a>
                                </li>
                                                            <li class="">
                                    <a href="https://php-di.org/doc/frameworks/zend-expressive.html">
                                        Zend Expressive
                                    </a>
                                </li>
                                                            <li class="">
                                    <a href="https://php-di.org/doc/frameworks/silly.html">
                                        Silly
                                    </a>
                                </li>
                                                            <li class="">
                                    <a href="https://php-di.org/doc/frameworks/silex.html">
                                        Silex
                                    </a>
                                </li>
                                                            <li class="">
                                    <a href="https://github.com/PHP-DI/demo">
                                        Demo application
                                    </a>
                                </li>
                                                    </ul>
                    </li>
                                    <li>
                        <span class="section-title">Advanced topics</span>

                        <ul>
                                                            <li class="active">
                                    <a href="https://php-di.org/doc/performances.html">
                                        Performances
                                    </a>
                                </li>
                                                            <li class="">
                                    <a href="https://php-di.org/doc/lazy-injection.html">
                                        Lazy injection
                                    </a>
                                </li>
                                                            <li class="">
                                    <a href="https://php-di.org/doc/inject-on-instance.html">
                                        Inject on an existing instance
                                    </a>
                                </li>
                                                            <li class="">
                                    <a href="https://php-di.org/doc/environments.html">
                                        Injections depending on the environment
                                    </a>
                                </li>
                                                            <li class="">
                                    <a href="https://php-di.org/doc/ide-integration.html">
                                        IDE integration
                                    </a>
                                </li>
                                                    </ul>
                    </li>
                                    <li>
                        <span class="section-title">Migration guides</span>

                        <ul>
                                                            <li class="">
                                    <a href="https://php-di.org/doc/migration/4.0.html">
                                        From PHP-DI 3.x to 4.0
                                    </a>
                                </li>
                                                            <li class="">
                                    <a href="https://php-di.org/doc/migration/5.0.html">
                                        From PHP-DI 4.x to 5.0
                                    </a>
                                </li>
                                                            <li class="">
                                    <a href="https://php-di.org/doc/migration/6.0.html">
                                        From PHP-DI 5.x to 6.0
                                    </a>
                                </li>
                                                            <li class="">
                                    <a href="https://php-di.org/doc/migration/7.0.html">
                                        From PHP-DI 6.x to 7.0
                                    </a>
                                </li>
                                                    </ul>
                    </li>
                                    <li>
                        <span class="section-title">Support</span>

                        <ul>
                                                            <li class="">
                                    <a href="https://php-di.org/support.html">
                                        Enterprise support
                                    </a>
                                </li>
                                                    </ul>
                    </li>
                                    <li>
                        <span class="section-title">Internals</span>

                        <ul>
                                                            <li class="">
                                    <a href="https://php-di.org/contributing.html">
                                        Contributing
                                    </a>
                                </li>
                                                            <li class="">
                                    <a href="https://php-di.org/doc/how-it-works.html">
                                        How PHP-DI works
                                    </a>
                                </li>
                                                    </ul>
                    </li>
                                    <li>
                        <span class="section-title">Old documentation</span>

                        <ul>
                                                            <li class="">
                                    <a href="https://github.com/PHP-DI/PHP-DI/tree/3.x/doc">
                                        PHP-DI 3.x
                                    </a>
                                </li>
                                                            <li class="">
                                    <a href="https://github.com/PHP-DI/PHP-DI/tree/4.x/doc">
                                        PHP-DI 4.x
                                    </a>
                                </li>
                                                            <li class="">
                                    <a href="https://github.com/PHP-DI/PHP-DI/tree/5.4/doc">
                                        PHP-DI 5.x
                                    </a>
                                </li>
                                                    </ul>
                    </li>
                            </ul>
        </div>

        <article>
            <div class="pull-right">
                <a href="https://github.com/PHP-DI/PHP-DI/blob/master/doc/performances.md" class="btn btn-default btn-sm" title="Fork PHP-DI and improve the documentation via a pull request">
                    Edit this page on GitHub
                </a>
            </div>

            <h1 id="performances">Performances</h1>
<h2 id="a-note-about-caching">A note about caching</h2>
<p>PHP-DI 4 and 5 relied a lot on caching. With PHP-DI 6 the main vector for optimization is now to compile the container into highly optimized code (see below). Compiling the container is simpler and faster.</p>
<h2 id="compiling-the-container">Compiling the container</h2>
<p>PHP-DI performs two tasks that can be expensive:</p>
<ul>
<li>reading definitions from your <a href="php-definitions.html">configuration</a>, from <a href="autowiring.html">autowiring</a> or from <a href="attributes.html">attributes</a></li>
<li>resolving those definitions to create your services</li>
</ul>
<p>In order to avoid those two tasks, the container can be compiled into PHP code optimized especially for your configuration and your classes.</p>
<h3 id="setup">Setup</h3>
<p>Compiling the container is as easy as calling the <code>enableCompilation()</code> method on the container builder:</p>
<pre><code class="language-php">$containerBuilder = new \DI\ContainerBuilder();
$containerBuilder-&gt;enableCompilation(__DIR__ . '/var/cache');

// […]

$container = $containerBuilder-&gt;build();</code></pre>
<p>The <code>enableCompilation()</code> method takes the path of the directory in which to store the compiled container.</p>
<h3 id="deployment-in-production">Deployment in production</h3>
<p>When a container is configured to be compiled, <strong>it will be compiled once and never be regenerated again</strong>. That allows for maximum performances in production.</p>
<p>When you deploy new versions of your code to production <strong>you must delete the generated file</strong> (or the directory that contains it) to ensure that the container is re-compiled.</p>
<p>If your production handles a lot of traffic you may also want to generate the compiled container <em>before</em> the new version of your code goes live. That phase is known as the &quot;warmup&quot; phase. To do this, simply create the container (call <code>$containerBuilder-&gt;build()</code>) during your deployment step and the compiled container will be created.</p>
<h3 id="development-environment">Development environment</h3>
<p><strong>Do not compile the container in a development environment</strong>, else all the changes you make to the definitions (attributes, configuration files, etc.) will not be taken into account. Here is an example of what you can do:</p>
<pre><code class="language-php">$containerBuilder = new \DI\ContainerBuilder();
if (/* is production */) {
    $containerBuilder-&gt;enableCompilation(__DIR__ . '/var/cache');
}</code></pre>
<h3 id="optimizing-for-compilation">Optimizing for compilation</h3>
<p>As you can read in the &quot;<em>How it works</em>&quot; section, PHP-DI will take all the definitions it can find and compile them. That means that definitions like <strong>autowired classes that are not listed in the configuration cannot be compiled</strong> since PHP-DI doesn't know about them.</p>
<p>If you want to optimize performances to a maximum in exchange for more verbosity, you can let PHP-DI know about all the autowired classes by listing them in definition files:</p>
<pre><code class="language-php">return [
    // ... (your definitions)

    UserController::class =&gt; autowire(),
    BlogController::class =&gt; autowire(),
    ProductController::class =&gt; autowire(),
    // ...
];</code></pre>
<p>You do not need to configure them (autowiring will still take care of that) but at least now PHP-DI will know about those classes and will compile their definitions.</p>
<p>Currently PHP-DI does not traverse directories to find autowired or annotated classes automatically.</p>
<p>It also does not resolve <a href="php-definitions.html#wildcards">wildcard definitions</a> during the compilation process. Those definitions will still work perfectly, they will simply not get a performance boost when using a compiled container.</p>
<p>On the other hand factory definitions (either defined with closures or with class factories) are supported in the compiled container. However please note that if you are using closures as factories:</p>
<ul>
<li>you should not use <code>$this</code> inside closures</li>
<li>you should not import variables inside the closure using the <code>use</code> keyword, like in <code>function () use ($foo) { ...</code></li>
</ul>
<p>These limitations exist because the code of each closure is copied into the compiled container. It is safe to say that you should probably not do these things even if you do not compile the container.</p>
<h3 id="how-it-works">How it works</h3>
<p>PHP-DI will read definitions from your <a href="php-definitions.html">configuration</a>. When the container is compiled, PHP code will be generated based on those definitions.</p>
<p>For example let's take the definition for creating an object:</p>
<pre><code class="language-php">return [
    'Logger' =&gt; DI\create()
        -&gt;constructor('/tmp/app.log')
        -&gt;method('setLevel', 'warning'),
];</code></pre>
<p>This definition will be compiled to PHP code similar to this:</p>
<pre><code class="language-php">$object = new Logger('/tmp/app.log');
$object-&gt;setLevel('warning');
return $object;</code></pre>
<p>All the compiled definitions will be dumped into a PHP class (the compiled container) which will be written to a file (for example <code>CompiledContainer.php</code>).</p>
<p>At runtime, the container builder will see that the file <code>CompiledContainer.php</code> exists and will load it (instead of loading the definition files). That PHP file may contain a lot of code but PHP's opcode cache will cache that class in memory (remember to use opcache in production). When a definition needs to be resolved, PHP-DI will simply execute the compiled code and return the created instance.</p>
<h2 id="optimizing-lazy-injection">Optimizing lazy injection</h2>
<p>If you are using the <a href="lazy-injection.html">Lazy Injection</a> feature you should read the section <a href="lazy-injection.html#optimizing-performances">&quot;Optimizing performances&quot; of the guide</a>.</p>
<h2 id="caching">Caching</h2>
<p>Compiling the container is the most efficient solution, but it has some limits. The following cases are not optimized:</p>
<ul>
<li>autowired (or annotated) classes that are not declared in the configuration</li>
<li>wildcard definitions</li>
<li>usage of <code>Container::make()</code> or <code>Container::injectOn()</code> (because those are not using the compiled code)</li>
</ul>
<p>If you make heavy use of those features, and if it slows down your application you can enable the caching system. The cache will ensure the reflection is not read again on every request.</p>
<p>The cache relies on APCu directly because it is the only cache system that makes sense (very fast to write and read). Other caches are not good options, this is why PHP-DI does not use PSR-6 or PSR-16 for this cache.</p>
<p>To enable the cache:</p>
<pre><code class="language-php">$containerBuilder = new \DI\ContainerBuilder();
if (/* is production */) {
    $containerBuilder-&gt;enableDefinitionCache();
}</code></pre>
<p>You can also pass an optional namespace argument to <code>enableDefinitionCache('my-namespace')</code> which will add the provided namespace to all PHP-DI cache keys. This is helpful to prevent cache collisions when sharing a single APCu memory pool between multiple DI containers. Here is an example of a PHP-DI cache key for a class named <code>MyClass</code> with, and without, a namespace:</p>
<ul>
<li>With namespace:  <code>php-di.definitions.my-namespaceMyClass</code></li>
<li>No namespace:    <code>php-di.definitions.MyClass</code></li>
</ul>
<p>Heads up:</p>
<ul>
<li>do not use a cache in a development environment, else changes you make to the definitions (attributes, configuration files, etc.) may not be taken into account</li>
<li>clear the APCu cache on each deployment in production (to avoid using a stale cache)</li>
</ul>
        </article>

    </div>


            <footer>
            <div class='container'>
                                    <p>
                        A question? Unsatisfied with the documentation?
                        <a href="https://github.com/PHP-DI/PHP-DI/issues/new">Open an issue</a>
                        or chat on
                        <a href="https://gitter.im/PHP-DI/PHP-DI" title="PHP-DI chat room">Gitter</a> or
                        <a href="https://twitter.com/phpdi" title="PHP-DI on Twitter">Twitter</a>.
                    </p>
                                <p>
                    <a href="https://twitter.com/share" class="twitter-share-button" data-related="PHPDI" data-dnt="true">Tweet</a>
                    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
                </p>
                <p>
                    By <a href="https://mnapoli.fr/" title="Software consulting and PHP news">Matthieu Napoli</a>
                    and <a href="https://github.com/PHP-DI/PHP-DI/graphs/contributors" title="PHP-DI contributors">contributors</a>
                    |
                    Website generated with
                    <a href="http://couscous.io" title="Static website generator for software documentation">Couscous</a>.
                </p>
                <p>
                    Want to support my work? Check out
                    <a href="https://serverless-visually-explained.com/?ref=php-di" title="Serverless course">Serverless Visually Explained</a>.
                </p>
            </div>
        </footer>
    
            <script src="https://php-di.org/bower_components/jquery/dist/jquery.min.js"></script>
        <script src="https://php-di.org/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/highlight.min.js"></script>

        <script>
            $(function() {
                hljs.initHighlightingOnLoad();

                // Add anchors to headers
                $('article h2, article h3, article h4, article h5').each(function () {
                    var url = document.URL.replace(/#.*$/, "") + '#' + $(this).attr('id');
                    $(this).append(' <a class="anchor" href="' + url + '">#</a>');
                });
            });
        </script>
    
    <script>
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-15584647-13']);
        _gaq.push(['_trackPageview']);
        (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
    </script>

    <!-- Gitter -->
    <script>
        ((window.gitter = {}).chat = {}).options = {
            room: 'PHP-DI/PHP-DI'
        };
    </script>
    <script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async defer></script>

    <script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script>
    <script type="text/javascript">
        $(function () {
            var search = docsearch({
                apiKey: 'ef6af24cbacae1f85d3c44741df49167',
                indexName: 'php-di',
                inputSelector: '#search-input'
            });
            var delay = (function () {
                var timer = 0;
                return function (callback, ms) {
                    clearTimeout(timer);
                    timer = setTimeout(callback, ms);
                };
            })();
            search.autocomplete.on('autocomplete:selected', function (e, suggestion) {
                var articleTitle = suggestion.subcategory;
                // Strip HTML tags
                var div = document.createElement("div");
                div.innerHTML = articleTitle;
                articleTitle = div.textContent || div.innerText || "";
                _gaq.push(['_trackEvent', 'search', 'click', articleTitle]);
            });
            $('#search-input').bind('input', function () {
                var search = $(this).val();
                if (search.length < 3) {
                    return;
                }
                delay(function () {
                    _gaq.push(['_trackPageview', '/search?q=' + search]);
                }, 600);
            });
        });
    </script>

</body>
</html>
